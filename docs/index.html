<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTSO Flare Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #121212; color: #eee; padding: 1rem; }
    h1 { text-align: center; margin-bottom: 1rem; }
    #controls { max-width: 600px; margin: 0 auto 1rem; padding: 1rem; background: #1e1e1e; border-radius: 8px; }
    #controls label { display: block; margin-bottom: 0.5rem; }
    select { width: 100%; padding: 0.5rem; background: #2a2a2a; border: 1px solid #333; color: #eee; border-radius: 4px; }
    #chart-container, #table-container { max-width: 600px; margin: 1rem auto; background: #1e1e1e; padding: 1rem; border-radius: 8px; }
    canvas { width: 100% !important; height: auto !important; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border: 1px solid #333; }
    th { background: #2a2a2a; }
  </style>
</head>
<body>
  <h1>FTSO Flare Dashboard</h1>
  <div id="controls">
    <label>
      Provider:
      <select id="providerSelect"></select>
    </label>
  </div>
  <div id="chart-container">
    <canvas id="ftsoChart"></canvas>
  </div>
  <div id="table-container">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Vote Power %</th>
          <th>24h % Change</th>
          <th>Reward Rate %</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    let snapshots = [];
    async function loadData() {
      const res = await fetch('https://api.github.com/repos/tripkane/flare-ftso-snapshot/contents/daily_snapshots');
      const files = await res.json();
      const urls = files.filter(f => f.name.endsWith('.json')).map(f => f.download_url);
      const data = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
      snapshots = data.map(s => ({ date: s.date, providers: s.providers }));
      populateProviders();
      render();
    }
    function populateProviders() {
      const sel = document.getElementById('providerSelect');
      const names = [...new Set(snapshots.flatMap(s => s.providers.map(p => p.name)))].sort();
      names.forEach(n => { const o = new Option(n, n); sel.add(o); });
      if (names.length) sel.value = names[0];
      sel.addEventListener('change', render);
    }
    function getSeries(name, field) {
      return snapshots.map(s => {
        const p = s.providers.find(x => x.name === name);
        let val = p && p[field] ? p[field].replace(/[^0-9.\-]/g, '') : null;
        val = val !== null ? parseFloat(val) : null;
        return { date: s.date, value: val };
      }).filter(d => d.value !== null);
    }
    let chart;
    function render() {
      const name = document.getElementById('providerSelect').value;
      const vpPct = getSeries(name, 'vote_power_pct');
      const change = getSeries(name, 'change_24h_pct');
      const rate = getSeries(name, 'reward_rate');
      const labels = snapshots.map(s => s.date);
      const ctx = document.getElementById('ftsoChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Vote Power %', data: vpPct.map(d => d.value), borderColor: 'cyan', fill: false },
            { label: '24h % Change', data: change.map(d => d.value), borderColor: 'orange', fill: false },
            { label: 'Reward Rate %', data: rate.map(d => d.value * 100), borderColor: 'lime', fill: false }
          ]
        },
        options: { responsive: true, scales: { y: { ticks: { callback: v => v + '%' } } } }
      });
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      const series = snapshots;
      series.forEach(s => {
        const p = s.providers.find(x => x.name === name);
        if (!p) return;
        const row = document.createElement('tr');
        const cells = [
          s.date,
          p.vote_power_pct,
          p.change_24h_pct,
          (parseFloat(p.reward_rate) * 100).toFixed(2) + '%'
        ];
        cells.forEach(c => { const td = document.createElement('td'); td.textContent = c; row.append(td); });
        tbody.append(row);
      });
    }
    loadData();
  </script>
</body>
</html>
