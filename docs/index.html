<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTSO Snapshot Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #121212; color: #eee; padding: 1rem; }
    h1 { text-align: center; margin-bottom: 1rem; }
    #controls { max-width: 600px; margin: 0 auto 1rem; padding: 1rem; background: #1e1e1e; border-radius: 8px; }
    #controls label { display: block; margin-bottom: 0.5rem; }
    select, input[type="checkbox"] { width: 100%; padding: 0.5rem; margin-top: 0.25rem; background: #2a2a2a; border: 1px solid #333; color: #eee; border-radius: 4px; }
    #chart-container, #table-container { max-width: 600px; margin: 1rem auto; background: #1e1e1e; padding: 1rem; border-radius: 8px; }
    canvas { width: 100% !important; height: auto !important; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border: 1px solid #333; }
    th { background: #2a2a2a; }
  </style>
</head>
<body>
  <h1>FTSO Snapshot Dashboard</h1>
  <div id="controls">
    <label>
      Registered Only
      <input type="checkbox" id="registeredOnly" />
    </label>
    <label>
      Provider
      <select id="providerSelect"></select>
    </label>
    <label>
      Metric
      <select id="metricSelect">
        <option value="vote_power">Vote Power</option>
        <option value="vote_power_pct">Vote Power %</option>
        <option value="change_24h_pct">24h % Change</option>
        <option value="reward_rate">Reward Rate</option>
      </select>
    </label>
  </div>
  <div id="chart-container">
    <canvas id="ftsoChart"></canvas>
  </div>
  <div id="table-container">
    <table id="dataTable">
      <thead>
        <tr><th>Date</th><th>Value</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    let snapshots = [], providers = [];

    async function loadSnapshots() {
      const res = await fetch('https://api.github.com/repos/tripkane/flare-ftso-snapshot/contents/daily_snapshots');
      const files = await res.json();
      const urls = files.filter(f => f.name.endsWith('.json')).map(f => f.download_url);
      const data = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
      snapshots = data.map(s => ({ date: s.date, providers: s.providers }));
      providers = [...new Set(snapshots.flatMap(s => s.providers.map(p => p.name)))].sort();
      populateProviderSelect();
      render();
    }

    function populateProviderSelect() {
      const sel = document.getElementById('providerSelect');
      sel.innerHTML = '';
      providers.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sel.append(opt);
      });
    }

    function getSeries(name, metric, regOnly) {
      return snapshots.map(s => {
        const p = s.providers.find(x => x.name === name);
        const val = p && (!regOnly || p.registered === 'Yes') ? parseFloat(p[metric]?.toString().replace(/,/g, '')) : null;
        return { date: s.date, value: val };
      }).filter(d => d.value !== null);
    }

    let chart;
    function render() {
      const name = document.getElementById('providerSelect').value;
      const metric = document.getElementById('metricSelect').value;
      const regOnly = document.getElementById('registeredOnly').checked;
      const series = getSeries(name, metric, regOnly);

      // Chart
      const ctx = document.getElementById('ftsoChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: series.map(d => d.date),
          datasets: [{ label: metric, data: series.map(d => d.value), fill: false, tension: 0.2 }]
        },
        options: { responsive: true }
      });

      // Table
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      series.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.date}</td><td>${d.value}</td>`;
        tbody.append(tr);
      });
    }

    document.getElementById('registeredOnly').addEventListener('change', render);
    document.getElementById('providerSelect').addEventListener('change', render);
    document.getElementById('metricSelect').addEventListener('change', render);

    loadSnapshots();
  </script>
</body>
</html>
