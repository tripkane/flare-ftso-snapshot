<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTSO Flare Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-100 font-sans">
  <header class="text-center py-4 bg-gray-800 border-b border-gray-700">
    <h1 class="text-2xl font-bold">FTSO Flare Dashboard</h1>
  </header>

  <main class="container mx-auto p-4">
    <!-- Controls -->
    <section class="flex flex-wrap gap-4 mb-6">
      <div class="flex-1 min-w-[200px]">
        <label class="block font-bold mb-2">Max Voting Power (%):</label>
        <input type="number" id="maxVotePowerInput" min="0" max="100" step="0.1" value="100"
          class="w-full p-2 bg-gray-800 border border-gray-700 rounded" />
      </div>
      <div class="flex-1 min-w-[200px]">
        <label class="block font-bold mb-2">
          <input type="checkbox" id="registeredOnly" class="mr-2" />
          Registered Only
        </label>
      </div>
      <div class="flex-1 min-w-[200px]">
        <label for="timeframe" class="block font-bold mb-2">Timeframe:</label>
        <select id="timeframe" class="w-full p-2 bg-gray-800 border border-gray-700 rounded">
          <option value="latest">Latest</option>
          <option value="7-day">7-Day Average</option>
          <option value="30-day">30-Day Average</option>
          <option value="cumulative">Cumulative Average</option>
        </select>
      </div>
    </section>

    <!-- Reward Rate Chart -->
    <section id="chartContainer" class="overflow-x-auto">
      <div id="rewardRateChart" class="w-full h-[400px]"></div>
    </section>

    <!-- Full Data Table -->
    <section>
      <h2 class="text-xl font-bold mt-6">Full Data Table</h2>
      <table class="w-full border-collapse mt-4 bg-gray-800 text-gray-100">
        <thead>
          <tr class="bg-gray-700">
            <th class="p-2 border border-gray-600">Date</th>
            <th class="p-2 border border-gray-600">Provider</th>
            <th class="p-2 border border-gray-600">Vote Power %</th>
            <th class="p-2 border border-gray-600">Reward Rate (%)</th>
          </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </section>
  </main>

  <script>
    async function loadData() {
      try {
        const res = await fetch('https://api.github.com/repos/tripkane/flare-ftso-snapshot/contents/daily_snapshots');
        const files = await res.json();
        const urls = files.filter(f => f.name.endsWith('.json')).map(f => f.download_url);
        const data = await Promise.all(urls.map(url => fetch(url).then(r => r.json())));
        snapshots = data.map(s => ({ date: s.date, providers: s.providers }));
        renderChart();
        renderTable();
      } catch (error) {
        console.error('Error loading data:', error);
        alert('Failed to load data. Please try again later.');
      }
    }

    function getFilteredProviders() {
      const maxVotePower = parseFloat(document.getElementById('maxVotePowerInput').value) || 100;
      const registeredOnly = document.getElementById('registeredOnly').checked;

      const filtered = snapshots.flatMap(snapshot =>
        snapshot.providers.filter(provider => {
          const votePower = parseFloat(provider.vote_power_pct); // Already in percentage
          const isRegistered = provider.registered.toLowerCase() === "yes"; // Check for "yes" or "no"
          return votePower <= maxVotePower && (!registeredOnly || isRegistered);
        }).map(provider => ({
          ...provider,
          date: snapshot.date // Attach the date from the snapshot
        }))
      );

      return filtered;
    }

    function renderChart() {
      const timeframe = document.getElementById('timeframe').value;
      const filteredProviders = getFilteredProviders();

      const rewardRates = {};
      filteredProviders.forEach(provider => {
        if (!rewardRates[provider.name]) rewardRates[provider.name] = [];
        rewardRates[provider.name].push(parseFloat(provider.reward_rate) || 0);
      });

      let data = Object.keys(rewardRates).map(name => {
        const rates = rewardRates[name];
        let average = 0;

        switch (timeframe) {
          case '7-day':
            average = rates.slice(-7).reduce((sum, rate) => sum + rate, 0) / Math.min(7, rates.length);
            break;
          case '30-day':
            average = rates.slice(-30).reduce((sum, rate) => sum + rate, 0) / Math.min(30, rates.length);
            break;
          case 'cumulative':
            average = rates.reduce((sum, rate) => sum + rate, 0) / rates.length;
            break;
          default:
            average = rates[rates.length - 1];
        }

        return { name, average: average.toFixed(4) }; // Keep raw average to 4 decimal places for precision
      });

      // Sort data by reward rate (highest to lowest)
      data = data.sort((a, b) => b.average - a.average);

      const chartData = {
        x: data.map(d => d.name),
        y: data.map(d => (parseFloat(d.average) * 100).toFixed(2)), // Convert to percentage and format to 2 decimal places
        type: 'bar',
        marker: { color: 'orange' }
      };

      Plotly.newPlot('rewardRateChart', [chartData], {
        title: `Reward Rate (%) - ${timeframe}`,
        xaxis: { title: 'Provider' },
        yaxis: { title: 'Reward Rate (%)' },
        margin: { t: 50, l: 50, r: 50, b: 50 },
        responsive: true
      });
    }

    function renderTable() {
      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = '';

      const filteredProviders = getFilteredProviders();

      filteredProviders.forEach(provider => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2 border border-gray-600">${provider.date}</td>
          <td class="p-2 border border-gray-600">${provider.name}</td>
          <td class="p-2 border border-gray-600">${parseFloat(provider.vote_power_pct).toFixed(2)}</td>
          <td class="p-2 border border-gray-600">${(parseFloat(provider.reward_rate) * 100).toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });
    }

    document.getElementById('maxVotePowerInput').addEventListener('input', () => {
      renderChart();
      renderTable();
    });
    document.getElementById('registeredOnly').addEventListener('change', () => {
      renderChart();
      renderTable();
    });
    document.getElementById('timeframe').addEventListener('change', renderChart);

    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>

</html>
