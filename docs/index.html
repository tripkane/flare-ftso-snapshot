<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTSO Snapshot Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f5f5f5; color: #333; }
    h1 { text-align: center; }
    #controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
    #controls label, select, input[type="checkbox"] { font-size: 0.9rem; }
    #chart-container, #table-container { max-width: 1000px; margin: 1rem auto; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    canvas { width:100% !important; height:auto !important; }
    table { width:100%; border-collapse: collapse; margin-top:1rem; }
    th, td { border:1px solid #ddd; padding:0.5rem; text-align:left; }
    th { background:#eee; cursor: pointer; }
    #status { text-align:center; color:red; }
  </style>
</head>
<body>
  <h1>FTSO Snapshot Dashboard</h1>
  <div id="controls">
    <label>Provider: <select id="providerSelect"></select></label>
    <label>Metric(s):
      <select id="metricSelect" multiple size="4">
        <option value="vote_power">Vote Power</option>
        <option value="vote_power_locked">Locked Vote Power</option>
        <option value="vote_power_pct">Vote Power %</option>
        <option value="vote_power_pct_locked">Locked Vote Power %</option>
        <option value="change_24h_pct">24h % Change</option>
        <option value="reward_rate">Reward Rate</option>
      </select>
    </label>
    <label><input type="checkbox" id="registeredOnly"> Registered Only</label>
    <label><input type="checkbox" id="showAverages"> Show Averages</label>
  </div>
  <div id="status"></div>
  <div id="chart-container"><canvas id="ftsoChart"></canvas></div>
  <div id="table-container">
    <table id="dataTable">
      <thead><tr><th>Date</th><th>Value</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    let snapshots = [];
    let providerList = [];

    async function fetchSnapshotDates() {
      const res = await fetch('https://api.github.com/repos/tripkane/flare-ftso-snapshot/contents/daily_snapshots');
      const files = await res.json();
      return files.filter(f => f.name.endsWith('.json')).map(f => f.download_url);
    }

    async function fetchSnapshots() {
      const urls = await fetchSnapshotDates();
      const data = await Promise.all(urls.map(u => fetch(u).then(r=>r.json())));
      snapshots = data.map(s => ({ date: s.date, providers: s.providers }));
      providerList = [...new Set(snapshots.flatMap(s => s.providers.map(p=>p.name)))].sort();
    }

    function populateProviderDropdown() {
      const sel = document.getElementById('providerSelect'); sel.innerHTML='';
      providerList.forEach(n=>{ let o=new Option(n,n); sel.append(o); });
    }

    function getSeries(provider, metric, registeredOnly) {
      return snapshots.map(s => {
        const p = s.providers.find(x=>x.name===provider);
        const val = p && (!registeredOnly||p.registered==='Yes') ? parseFloat((p[metric]||0).toString().replace(/,/g,'')) : null;
        return {date: s.date, value: val};
      }).filter(d=>d.value!==null);
    }

    function computeAverage(series, days) {
      const now = series.length;
      const slice = series.slice(Math.max(0, now-days));
      const sum = slice.reduce((a,c)=>a+c.value,0);
      return sum/slice.length;
    }

    let chart;
    function renderChart() {
      const provider = document.getElementById('providerSelect').value;
      const metrics = [...document.getElementById('metricSelect').selectedOptions].map(o=>o.value);
      const registeredOnly = document.getElementById('registeredOnly').checked;
      const showAvg = document.getElementById('showAverages').checked;
      const datasets = [];
      metrics.forEach(m=>{
        const series = getSeries(provider,m,registeredOnly);
        datasets.push({ label: m, data: series.map(d=>d.value), fill:false, tension:0.2 });
        if(showAvg) {
          const avg7 = computeAverage(series,7);
          datasets.push({ label: m+' (7d avg)', data: series.map(_=>avg7), borderDash:[5,5], fill:false });
          const avg30 = computeAverage(series,30);
          datasets.push({ label: m+' (30d avg)', data: series.map(_=>avg30), borderDash:[2,2], fill:false });
        }
      });
      const labels = snapshots.map(s=>s.date);
      const ctx = document.getElementById('ftsoChart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx,{ type:'line', data:{ labels, datasets }, options:{ responsive:true } });
      renderTable(provider, metrics, registeredOnly);
    }

    function renderTable(provider, metrics, registeredOnly) {
      const tbody = document.querySelector('#dataTable tbody'); tbody.innerHTML='';
      const rows = getSeries(provider, metrics[0], registeredOnly);
      rows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.date}</td><td>${r.value}</td>`;
        tbody.append(tr);
      });
    }

    document.getElementById('providerSelect').addEventListener('change',renderChart);
    document.getElementById('metricSelect').addEventListener('change',renderChart);
    document.getElementById('registeredOnly').addEventListener('change',renderChart);
    document.getElementById('showAverages').addEventListener('change',renderChart);

    (async()=>{
      document.getElementById('status').textContent='Loading data...';
      await fetchSnapshots();
      populateProviderDropdown();
      document.getElementById('status').textContent='';
      renderChart();
    })();
  </script>
</body>
</html>
